# This action.yml provides a GitHub Action for building NCEP libraries with
# CMake.
# Alex Richert, April 2024
name: 'Build NCEPLIBS'
description: 'Builds and installs requested versions/configurations of various NCEPLIBS'

inputs:
  jasper-version:
    default: ""
  jasper-cmake-args:
    default: ""
  bacio-version:
    default: ""
  bacio-cmake-args:
    default: ""
  bufr-version:
    default: ""
  bufr-cmake-args:
    default: ""
  g2-version:
    default: ""
  g2-cmake-args:
    default: ""
  g2c-version:
    default: ""
  g2c-cmake-args:
    default: "-DJasper_ROOT=${{ github.workspace }}/nceplibs/jasper"
  ip-version:
    default: ""
  ip-cmake-args:
    default: ""
  sp-version:
    default: ""
  sp-cmake-args:
    default: ""
  w3emc-version:
    default: ""
  w3emc-cmake-args:
    default: ""
  repo-cache:
    description: 'Cache built packages through "actions/cache"'
    default: false
  cache-checkout-build-version:
    default: develop

runs:
  using: "composite"

  steps:

    - name: "Build 'jasper'"
      uses: AlexanderRichert-NOAA/cache-checkout-build@${{ inputs.cache-checkout-build-version }}
      if: ${{ inputs.jasper-version }}
      with:
        package-name: jasper
        package-org: jasper-software
        cmake-args: ${{ inputs.jasper-cmake-args }}
        git-ref: ${{ inputs.jasper-version }}
        repo-cache: ${{ inputs.repo-cache }}

    - name: "Build 'bacio'"
      uses: AlexanderRichert-NOAA/cache-checkout-build@${{ inputs.cache-checkout-build-version }}
      if: ${{ inputs.bacio-version }}
      with:
        package-name: NCEPLIBS-bacio
        package-org: NOAA-EMC
        cmake-args: ${{ inputs.bacio-cmake-args }}
        git-ref: ${{ inputs.bacio-version }}
        repo-cache: ${{ inputs.repo-cache }}

    - name: "Build 'bufr'"
      uses: AlexanderRichert-NOAA/cache-checkout-build@${{ inputs.cache-checkout-build-version }}
      if: ${{ inputs.bufr-version }}
      with:
        package-name: NCEPLIBS-bufr
        package-org: NOAA-EMC
        cmake-args: ${{ inputs.bufr-cmake-args }} -DTEST_FILE_DIR=/dev/null
        git-ref: ${{ inputs.bufr-version }}
        repo-cache: ${{ inputs.repo-cache }}

    - name: "Build 'w3emc'"
      uses: AlexanderRichert-NOAA/cache-checkout-build@${{ inputs.cache-checkout-build-version }}
      if: ${{ inputs.w3emc-version }}
      with:
        package-name: NCEPLIBS-w3emc
        package-org: NOAA-EMC
        cmake-args: ${{ inputs.w3emc-cmake-args }} -DCMAKE_PREFIX_PATH="${{ github.workspace }}/nceplibs/NCEPLIBS-bufr;${{ github.workspace }}/nceplibs/NCEPLIBS-bacio"
        git-ref: ${{ inputs.w3emc-version }}
        repo-cache: ${{ inputs.repo-cache }}
        key-add: -bacio-${{ inputs.bacio-version }}-${{ inputs.bacio-cmake-args }}

    - name: "Build 'sp'"
      uses: AlexanderRichert-NOAA/cache-checkout-build@${{ inputs.cache-checkout-build-version }}
      if: ${{ inputs.sp-version }}
      with:
        package-name: NCEPLIBS-sp
        package-org: NOAA-EMC
        cmake-args: ${{ inputs.sp-cmake-args }}
        git-ref: ${{ inputs.sp-version }}
        repo-cache: ${{ inputs.repo-cache }}

    - name: "Build 'ip'"
      uses: AlexanderRichert-NOAA/cache-checkout-build@${{ inputs.cache-checkout-build-version }}
      if: ${{ inputs.ip-version }}
      with:
        package-name: NCEPLIBS-ip
        package-org: NOAA-EMC
        cmake-args: ${{ inputs.ip-cmake-args }} -DCMAKE_PREFIX_PATH="${{ github.workspace }}/nceplibs/NCEPLIBS-sp"
        git-ref: ${{ inputs.ip-version }}
        repo-cache: ${{ inputs.repo-cache }}

    - name: "Build 'g2c'"
      uses: AlexanderRichert-NOAA/cache-checkout-build@${{ inputs.cache-checkout-build-version }}
      if: ${{ inputs.g2c-version }}
      with:
        package-name: NCEPLIBS-g2c
        package-org: NOAA-EMC
        cmake-args: ${{ inputs.g2c-cmake-args }}
        git-ref: ${{ inputs.g2c-version }}
        repo-cache: ${{ inputs.repo-cache }}
        key-add: -jasper-${{ inputs.jasper-version }}-${{ inputs.jasper-cmake-args }}

    - name: "Build 'g2'"
      uses: AlexanderRichert-NOAA/cache-checkout-build@${{ inputs.cache-checkout-build-version }}
      if: ${{ inputs.g2-version }}
      with:
        package-name: NCEPLIBS-g2
        package-org: NOAA-EMC
        cmake-args: ${{ inputs.g2-cmake-args }} -DCMAKE_PREFIX_PATH="${{ github.workspace }}/nceplibs/NCEPLIBS-bacio;${{ github.workspace }}/nceplibs/NCEPLIBS-w3emc;${{ github.workspace }}/nceplibs/jasper"
        git-ref: ${{ inputs.g2-version }}
        repo-cache: ${{ inputs.repo-cache }}
        key-add: -bacio-${{ inputs.bacio-version }}-${{ inputs.bacio-cmake-args }}-w3emc-${{ inputs.w3emc-version }}-${{ inputs.w3emc-cmake-args }}-jasper-${{ inputs.jasper-version }}-${{ inputs.jasper-cmake-args }}
